<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>원가 계산기</title>
  <style>
    :root{
      --bg:#f5f6f8;
      --card:#ffffff;
      --line:#e9ebef;
      --text:#111;
      --sub:#6b7280;
      --brand:#10cfc9;
      --brand2:#0fbab5;
      --danger:#e11d48;
      --shadow:0 8px 24px rgba(0,0,0,.06);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
      background:var(--bg); color:var(--text);
    }
    .wrap{max-width:980px; margin:0 auto; padding:14px 12px 96px}
    .topbar{
      position:sticky; top:0; z-index:50;
      background:rgba(245,246,248,.85); backdrop-filter:saturate(1.2) blur(10px);
      padding:10px 0 12px;
    }
    .titleRow{display:flex; gap:10px; align-items:center; padding:0 12px}
    .title{font-weight:900; font-size:18px}
    .muted{color:var(--sub); font-size:12px; font-weight:800}
    .pillBtn{
      border:1px solid var(--line);
      background:#fff;
      border-radius:999px;
      padding:8px 12px;
      font-weight:900;
      cursor:pointer;
    }
    .pillBtn.on{background:#111; color:#fff; border-color:#111;}
    .pillBtn.brand{background:var(--brand); border-color:transparent; color:#003b39;}
    .controls{
      display:flex; gap:8px; flex-wrap:wrap;
      padding:10px 12px 0;
    }
    select, input[type="text"], input[type="number"]{
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 12px;
      background:#fff;
      font-weight:800;
      outline:none;
    }
    .sizeSeg{display:flex; gap:6px; align-items:center}
    .segBtn{
      border:1px solid var(--line);
      background:#fff;
      border-radius:999px;
      padding:10px 14px;
      font-weight:1000;
      cursor:pointer;
    }
    .segBtn.active{border:2px solid var(--brand2); background:#e6fffe}
    .ghostBtn{
      border:1px solid var(--line);
      background:#fff;
      border-radius:12px;
      padding:10px 12px;
      font-weight:900;
      cursor:pointer;
    }
    .summaryGrid{
      padding:12px;
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap:10px;
    }
    @media (max-width:860px){
      .summaryGrid{grid-template-columns: repeat(2, minmax(0,1fr));}
    }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
    }
    .sumCard{padding:12px}
    .sumTitle{font-size:12px; color:var(--sub); font-weight:900}
    .sumValue{margin-top:6px; font-size:18px; font-weight:1000}
    .sumValue.bad{color:var(--danger)}
    .feeRow{
      padding:0 12px 12px;
      display:flex; gap:12px; flex-wrap:wrap;
      color:#4b5563; font-size:12px; font-weight:800;
    }
    .section{
      margin-top:12px;
      overflow:hidden;
    }
    .secHead{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .secTitle{font-weight:1000}
    .secSub{margin-top:4px; font-size:12px; color:var(--sub); font-weight:800}
    .optList{padding:0}
    .optRow{
      display:grid;
      grid-template-columns: 28px 1fr auto;
      gap:10px;
      align-items:center;
      padding:12px 14px;
      border-bottom:1px solid #f0f2f6;
    }
    .optRow:last-child{border-bottom:0}
    .optName{font-weight:1000}
    .optMeta{margin-top:3px; font-size:12px; color:var(--sub); font-weight:800}
    .rightMini{min-width:120px; display:flex; justify-content:flex-end}
    input[type="radio"], input[type="checkbox"]{width:18px; height:18px}
    .qty{
      display:flex; align-items:center; gap:8px;
      border:1px solid var(--line);
      border-radius:12px;
      padding:6px 8px;
      background:#fff;
    }
    .qty button{
      width:28px; height:28px; border-radius:10px;
      border:1px solid var(--line);
      background:#fff;
      font-weight:1000;
      cursor:pointer;
    }
    .qty .n{min-width:22px; text-align:center; font-weight:1000}
    .tableCard{margin-top:12px; overflow:hidden}
    .tableHead{padding:12px 14px; border-bottom:1px solid var(--line); font-weight:1000}
    .tableBody{padding:12px}
    .rowBox{
      display:grid;
      grid-template-columns: 1fr auto auto auto;
      gap:10px;
      align-items:center;
      padding:12px;
      border:1px solid #f0f2f6;
      border-radius:14px;
      margin-bottom:8px;
      background:#fff;
    }
    .rowBox:last-child{margin-bottom:0}
    .profit{font-weight:1000}
    .profit.pos{color:var(--brand2)}
    .profit.neg{color:var(--danger)}
    .divider{width:1px; height:36px; background:var(--line)}
    .hint{margin-top:12px; color:#6b7280; font-size:12px; line-height:1.55; font-weight:800}
    .bottomBar{
      position:fixed; left:0; right:0; bottom:0; z-index:60;
      padding:10px 12px calc(10px + env(safe-area-inset-bottom));
      background:rgba(245,246,248,.92);
      border-top:1px solid rgba(233,235,239,.8);
      backdrop-filter:saturate(1.2) blur(10px);
    }
    .bottomInner{
      max-width:980px; margin:0 auto;
      display:flex; gap:10px; align-items:center;
    }
    .cta{
      margin-left:auto;
      background:var(--brand);
      color:#003b39;
      border:0;
      border-radius:14px;
      padding:14px 16px;
      font-weight:1000;
      cursor:pointer;
      min-width:220px;
      box-shadow:0 10px 26px rgba(16,207,201,.22);
    }
    .cta small{display:block; font-size:11px; font-weight:1000; opacity:.75}
    .cta strong{display:block; font-size:18px; font-weight:1000}
    .badge{display:inline-flex; align-items:center; gap:6px}
    .dot{width:8px; height:8px; border-radius:50%; background:var(--brand2)}
    /* Menu cards (scroll) */
    .menuCardWrap{padding:10px 12px 0}
    .menuSearchRow{display:flex; gap:8px; padding:0 12px 10px}
    .menuCards{
      display:flex;
      gap:10px;
      overflow-x:auto;
      padding:0 12px 12px;
      scroll-snap-type:x mandatory;
      -webkit-overflow-scrolling:touch;
    }
    .menuCard{
      min-width:220px;
      scroll-snap-align:start;
      background:#fff;
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow: var(--shadow);
      padding:12px;
      cursor:pointer;
      position:relative;
    }
    .menuCard.active{
      border:2px solid var(--brand2);
      background:#e6fffe;
    }
    .menuCard .mName{font-weight:1000; font-size:16px}
    .menuCard .mMeta{margin-top:6px; font-size:12px; color:var(--sub); font-weight:900}
    .menuCard .mTag{
      position:absolute; top:10px; right:10px;
      font-size:11px; font-weight:1000;
      border-radius:999px;
      padding:6px 8px;
      background:#111; color:#fff;
      opacity:.9;
    }
    /* Pages */
    .page{display:none}
    .page.on{display:block}
    /* Admin */
    .adminTop{
      display:flex; gap:8px; flex-wrap:wrap;
      padding:12px;
      border-bottom:1px solid var(--line);
    }
    .tabBtn{
      border:1px solid var(--line);
      background:#fff;
      border-radius:999px;
      padding:10px 12px;
      font-weight:1000;
      cursor:pointer;
    }
    .tabBtn.active{background:#111; color:#fff; border-color:#111;}
    .adminPane{padding:12px}
    .grid2{display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px}
    @media (max-width:720px){ .grid2{grid-template-columns:1fr} }
    .field label{display:block; font-size:12px; color:#374151; font-weight:1000; margin-bottom:6px}
    .field input, .field select{width:100%}
    .smallBtn{padding:10px 12px; border-radius:12px; font-weight:1000}
    .dangerBtn{background:var(--danger)}
    .listCol{display:flex; flex-direction:column; gap:8px}
    .miniCard{
      border:1px solid #f0f2f6;
      border-radius:14px;
      padding:12px;
      background:#fff;
    }
    .miniCard .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .miniCard .row .name{font-weight:1000}
    .miniCard .row .sub{font-size:12px; color:var(--sub); font-weight:900}
    .miniCard .row .right{margin-left:auto; display:flex; gap:8px}
  </style>
</head>

<body>
  <div class="topbar">
    <div class="wrap" style="padding-bottom:0">
      <div class="card">
        <div class="titleRow" style="padding:12px 14px">
          <div>
            <div class="title" id="appTitle">원가 계산기</div>
            <div class="muted">메뉴선택 카드형 · 옵션 Sheet2 연동 · 로컬 저장</div>
          </div>
          <button class="pillBtn brand" id="goMenuBtn">메뉴선택</button>
          <button class="pillBtn" id="goAdminBtn">관리자</button>
        </div>

        <!-- MENU PAGE: menu cards + search -->
        <div id="menuHeaderBlock" class="page on">
          <div class="menuSearchRow">
            <input type="text" id="menuSearch" placeholder="메뉴 검색 (한 글자만 일치해도 검색)" />
            <button class="ghostBtn" id="menuResetBtn">선택 초기화</button>
          </div>
          <div class="menuCards" id="menuCards"></div>

          <div class="controls">
            <select id="platformSel"></select>
            <div class="sizeSeg" id="sizeSeg"></div>
            <select id="couponSel"></select>
            <select id="extraDeliverySel"></select>
            <button class="ghostBtn" id="resetBtn">전체 초기화</button>
          </div>

          <div class="summaryGrid">
            <div class="sumCard card">
              <div class="sumTitle">총 결제금액(쿠폰 전)</div>
              <div class="sumValue" id="grossPrice">-</div>
            </div>
            <div class="sumCard card">
              <div class="sumTitle">실매출(쿠폰 적용)</div>
              <div class="sumValue" id="netRevenue">-</div>
            </div>
            <div class="sumCard card">
              <div class="sumTitle">총 원가</div>
              <div class="sumValue" id="totalCost">-</div>
            </div>
            <div class="sumCard card">
              <div class="sumTitle" id="profitTitle">실마진</div>
              <div class="sumValue" id="profit">-</div>
            </div>
          </div>

          <div class="feeRow">
            <span>플랫폼수수료: <b id="platformFee">-</b></span>
            <span>카드수수료: <b id="cardFee">-</b></span>
            <span>배달비: <b id="deliveryFee">-</b></span>
          </div>
        </div>

        <!-- ADMIN PAGE: just placeholder header -->
        <div id="adminHeaderBlock" class="page">
          <div class="controls" style="padding-top:0">
            <div class="muted" style="padding:10px 12px 0">관리자에서 메뉴/플랫폼/옵션(Sheet2)을 설정하면 메뉴선택 페이지에 자동 반영됩니다.</div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <div class="wrap">

    <!-- MENU PAGE BODY -->
    <div id="pageMenu" class="page on">
      <div id="sections"></div>

      <div class="card tableCard">
        <div class="tableHead">선택 옵션 손익 (옵션 단독)</div>
        <div class="tableBody" id="profitRows"></div>
      </div>

      <div class="hint">
        - 수수료는 <b>쿠폰 적용된 실매출</b> 기준으로 계산됨<br/>
        - 데이터는 브라우저에 저장됨(로컬 저장).<br/>
        - 옵션은 관리자 &gt; 옵션설정(Sheet2)에서 추가/수정 가능
      </div>
    </div>

    <!-- ADMIN PAGE BODY -->
    <div id="pageAdmin" class="page">
      <div class="card">
        <div class="adminTop">
          <button class="tabBtn active" id="tabMenus">메뉴 설정</button>
          <button class="tabBtn" id="tabPlatform">플랫폼 설정</button>
          <button class="tabBtn" id="tabOptions">옵션 설정 (Sheet2)</button>
        </div>

        <!-- Pane: Menus -->
        <div class="adminPane" id="paneMenus">
          <div class="grid2">
            <div class="field">
              <label>메뉴 선택</label>
              <select id="adminMenuSel"></select>
            </div>
            <div class="field">
              <label>메뉴명</label>
              <input type="text" id="adminMenuName" />
            </div>
          </div>

          <div class="grid2" style="margin-top:10px">
            <div class="miniCard">
              <div style="font-weight:1000; margin-bottom:8px">판매가</div>
              <div class="grid2">
                <div class="field"><label>S</label><input type="number" id="mPriceS" /></div>
                <div class="field"><label>M</label><input type="number" id="mPriceM" /></div>
                <div class="field"><label>L</label><input type="number" id="mPriceL" /></div>
              </div>
            </div>
            <div class="miniCard">
              <div style="font-weight:1000; margin-bottom:8px">기본 원가(사이즈별)</div>
              <div class="grid2">
                <div class="field"><label>S</label><input type="number" id="mCostS" /></div>
                <div class="field"><label>M</label><input type="number" id="mCostM" /></div>
                <div class="field"><label>L</label><input type="number" id="mCostL" /></div>
              </div>
            </div>
          </div>

          <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px">
            <button class="smallBtn" id="saveMenuBtn">저장</button>
            <button class="smallBtn" id="addMenuBtn">+ 메뉴 추가</button>
            <button class="smallBtn dangerBtn" id="deleteMenuBtn">메뉴 삭제</button>
          </div>

          <div class="hint">
            - 기본 원가는 메뉴 레시피(다음 단계)로 자동 계산도 가능하지만, 지금은 수기로 입력해도 됩니다.<br/>
            - 메뉴 추가하면 메뉴선택 카드에 자동으로 뜹니다.
          </div>
        </div>

        <!-- Pane: Platform -->
        <div class="adminPane" id="panePlatform" style="display:none">
          <div class="grid2">
            <div class="field">
              <label>플랫폼 설정</label>
              <select id="adminPlatformSel"></select>
            </div>
            <div class="field">
              <label>플랫폼 표시명</label>
              <input type="text" id="pName" />
            </div>
          </div>

          <div class="grid2" style="margin-top:10px">
            <div class="field">
              <label>플랫폼 수수료율 (예: 0.0858)</label>
              <input type="number" step="0.0001" id="pFeeRate" />
            </div>
            <div class="field">
              <label>카드 수수료율 (예: 0.03)</label>
              <input type="number" step="0.0001" id="pCardRate" />
            </div>
            <div class="field">
              <label>기본 배달비</label>
              <input type="number" id="pDelivery" />
            </div>
          </div>

          <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px">
            <button class="smallBtn" id="savePlatformBtn">저장</button>
            <button class="smallBtn" id="addPlatformBtn">+ 플랫폼 추가</button>
            <button class="smallBtn dangerBtn" id="deletePlatformBtn">플랫폼 삭제</button>
          </div>

          <div class="hint">
            - 메뉴선택 상단 드롭다운(배민/요기요/쿠팡이츠 등)에 그대로 반영됩니다.
          </div>
        </div>

        <!-- Pane: Options (Sheet2) -->
        <div class="adminPane" id="paneOptions" style="display:none">
          <div class="miniCard">
            <div style="display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap">
              <div>
                <div style="font-weight:1000">옵션 그룹</div>
                <div class="muted">라디오/체크(최대 N개)/수량형 그룹을 만들 수 있음</div>
              </div>
              <button class="smallBtn" id="addGroupBtn">+ 그룹 추가</button>
            </div>
            <div class="listCol" id="groupList" style="margin-top:10px"></div>
          </div>

          <div class="miniCard" style="margin-top:10px">
            <div style="display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap">
              <div>
                <div style="font-weight:1000">옵션 목록 (Sheet2)</div>
                <div class="muted">여기서 만든 옵션이 메뉴선택 화면에 자동으로 뜸</div>
              </div>
              <button class="smallBtn" id="addOptionBtn">+ 옵션 추가</button>
            </div>
            <div class="listCol" id="optionList" style="margin-top:10px"></div>
          </div>

          <div class="hint">
            - 그룹 종류: <b>radio</b>(1개 선택), <b>check_limit</b>(최대 N개), <b>check_qty</b>(수량형)<br/>
            - 옵션 타입은 그룹 종류에 맞게: radio / check / check_qty 로 저장됩니다.
          </div>
        </div>

      </div>
    </div>

  </div>

  <div class="bottomBar">
    <div class="bottomInner">
      <div class="badge">
        <span class="dot"></span>
        <span class="muted">메뉴 선택 → 옵션 선택 → 자동 계산</span>
      </div>
      <button class="cta" id="ctaBtn" type="button">
        <small>현재 실마진</small>
        <strong id="ctaProfit">-</strong>
      </button>
    </div>
  </div>

<script>
/** =========================
 *  Helpers
 *  ========================= */
const clamp = (n, min, max) => Math.max(min, Math.min(max, n));
const toNumber = (v, fallback=0) => {
  const n = (typeof v === 'number') ? v : Number(String(v ?? "").replace(/,/g,''));
  return Number.isFinite(n) ? n : fallback;
};
const won = (n) => (Math.round(n)).toLocaleString('ko-KR') + '원';
const pct = (n) => (Math.round(n*10)/10).toFixed(1) + '%';
const uid = (prefix="id") => prefix + "_" + Math.random().toString(16).slice(2) + Date.now().toString(16);

const LS = {
  get(key, fallback){
    try{ const raw = localStorage.getItem(key); if(!raw) return fallback; return JSON.parse(raw); }
    catch{ return fallback; }
  },
  set(key, val){
    try{ localStorage.setItem(key, JSON.stringify(val)); }catch{}
  }
};

/** =========================
 *  Data model
 *  ========================= */
const SizeKeys = ['S','M','L'];

const DEFAULT = {
  appTitle: "원가 계산기",
  menus: [
    { id:"m_chung", name:"충성콤비네이션", sizes:{ S:{price:14900, baseCost:0}, M:{price:19900, baseCost:0}, L:{price:23900, baseCost:0} } },
    { id:"m_bulgogi", name:"불고기피자", sizes:{ S:{price:14900, baseCost:0}, M:{price:19900, baseCost:0}, L:{price:23900, baseCost:0} } },
    { id:"m_pepper", name:"페퍼로니", sizes:{ S:{price:13900, baseCost:0}, M:{price:18900, baseCost:0}, L:{price:22900, baseCost:0} } },
  ],
  platforms: {
    BAEMIN_DELIVERY: { name:'배민', platformFeeRate:0.0858, cardFeeRate:0.03, deliveryFee:3400 },
    BAEMIN_STORE:    { name:'배민 가게배달', platformFeeRate:0.0787, cardFeeRate:0.03, deliveryFee:3400 },
    BAEMIN_PICKUP:   { name:'배민 포장', platformFeeRate:0.0787, cardFeeRate:0.03, deliveryFee:0 },
    YOGIYO_DELIVERY: { name:'요기요', platformFeeRate:0.0737, cardFeeRate:0.03, deliveryFee:3190 },
    YOGIYO_STORE:    { name:'요기요 가게배달', platformFeeRate:0.1067, cardFeeRate:0.03, deliveryFee:3190 },
    YOGIYO_PICKUP:   { name:'요기요 포장', platformFeeRate:0.0847, cardFeeRate:0.03, deliveryFee:0 },
    COUPANG_DELIVERY:{ name:'쿠팡이츠', platformFeeRate:0.0858, cardFeeRate:0.03, deliveryFee:3730 },
  },
  optionGroups: [
    { id:"REVIEW1", title:"리뷰이벤트1", subtitle:"필수", kind:"radio", maxSelect:1 },
    { id:"REVIEW2", title:"리뷰이벤트2", subtitle:"필수", kind:"radio", maxSelect:1 },
    { id:"TOPPING", title:"토핑 추가선택", subtitle:"최대 2개", kind:"check_limit", maxSelect:2 },
    { id:"SAUCE_QTY", title:"소스 추가선택(기본미제공)", subtitle:"최대 4개", kind:"check_qty", maxSelect:4 },
  ],
  options: [
    // REVIEW1
    { id:"rv1_next", groupId:"REVIEW1", type:"radio", name:"다음에 참여할게요", priceDelta:0, costDelta:0, maxQty:1, enabled:true },
    { id:"rv1_cheese", groupId:"REVIEW1", type:"radio", name:"모짜렐라 치즈 추가", priceDelta:0, costDelta:0, maxQty:1, enabled:true },
    // REVIEW2
    { id:"rv2_next", groupId:"REVIEW2", type:"radio", name:"다음에 참여할게요", priceDelta:0, costDelta:0, maxQty:1, enabled:true },
    { id:"rv2_pickle", groupId:"REVIEW2", type:"radio", name:"피클+", priceDelta:0, costDelta:0, maxQty:1, enabled:true },
    // TOPPING (limit 2)
    { id:"top_cheese", groupId:"TOPPING", type:"check", name:"치즈 추가", priceDelta:3000, costDelta:0, maxQty:1, enabled:true },
    { id:"top_pepper", groupId:"TOPPING", type:"check", name:"페퍼로니 추가", priceDelta:2000, costDelta:0, maxQty:1, enabled:true },
    // SAUCE_QTY
    { id:"sq_pickle", groupId:"SAUCE_QTY", type:"check_qty", name:"피클 추가", priceDelta:500, costDelta:0, maxQty:4, enabled:true },
    { id:"sq_garlic", groupId:"SAUCE_QTY", type:"check_qty", name:"갈릭소스 추가", priceDelta:500, costDelta:0, maxQty:4, enabled:true },
  ],
};

const KEYS = {
  cfg: "cost_app_cfg_v2",
  state: "cost_app_state_v2",
};

let cfg = LS.get(KEYS.cfg, DEFAULT);
let state = LS.get(KEYS.state, {
  page: "menu",            // menu | admin
  activeMenuId: cfg.menus[0]?.id || "",
  platformKey: Object.keys(cfg.platforms)[0] || "BAEMIN_DELIVERY",
  size: "M",
  coupon: 0,
  storeDeliveryExtra: 0,
  // per-menu selection state
  menuState: {
    // [menuId]: { radio:{}, checked:{}, qty:{} }
  }
});

function save(){ LS.set(KEYS.cfg, cfg); LS.set(KEYS.state, state); }

/** =========================
 *  DOM refs
 *  ========================= */
const $ = (id)=>document.getElementById(id);

const goMenuBtn = $("goMenuBtn");
const goAdminBtn = $("goAdminBtn");

const menuHeaderBlock = $("menuHeaderBlock");
const adminHeaderBlock = $("adminHeaderBlock");
const pageMenu = $("pageMenu");
const pageAdmin = $("pageAdmin");

const menuSearch = $("menuSearch");
const menuCards = $("menuCards");
const menuResetBtn = $("menuResetBtn");

const platformSel = $("platformSel");
const sizeSeg = $("sizeSeg");
const couponSel = $("couponSel");
const extraDeliverySel = $("extraDeliverySel");
const resetBtn = $("resetBtn");
const sections = $("sections");
const profitRows = $("profitRows");

/** =========================
 *  Page switching
 *  ========================= */
function setPage(p){
  state.page = p;
  save();
  rerender(true);
}
goMenuBtn.addEventListener("click",()=>setPage("menu"));
goAdminBtn.addEventListener("click",()=>setPage("admin"));

/** =========================
 *  Menu helpers
 *  ========================= */
function getMenuById(id){
  return cfg.menus.find(m=>m.id===id) || cfg.menus[0];
}
function ensureMenuState(menuId){
  if(!state.menuState[menuId]){
    state.menuState[menuId] = { radio:{}, checked:{}, qty:{} };
  }
  return state.menuState[menuId];
}
function currentSel(){
  return ensureMenuState(state.activeMenuId);
}

/** =========================
 *  Options helpers
 *  ========================= */
function getGroupMeta(groupId){
  return cfg.optionGroups.find(g=>g.id===groupId);
}
function getOptionsByGroup(groupId){
  return cfg.options.filter(o=>o.groupId===groupId && o.enabled!==false);
}
function ensureRadioDefaultsForMenu(menuId){
  const ms = ensureMenuState(menuId);
  cfg.optionGroups.filter(g=>g.kind==="radio").forEach(g=>{
    const list = getOptionsByGroup(g.id);
    if(!list.length) return;
    const cur = ms.radio[g.id];
    if(!cur || !list.some(o=>o.id===cur)){
      ms.radio[g.id] = list[0].id;
    }
  });
}

/** =========================
 *  Render: top & controls
 *  ========================= */
function renderAppTitle(){
  $("appTitle").textContent = cfg.appTitle || "원가 계산기";
}

function renderMenuCards(){
  const q = (menuSearch.value || "").trim();
  const tokens = q ? q.split(/\s+/).filter(Boolean) : [];
  const list = cfg.menus.filter(m=>{
    if(!tokens.length) return true;
    // "한 글자만 일치해도" -> substring match OR any token char exists
    const name = m.name || "";
    return tokens.some(t=>{
      if(!t) return false;
      if(name.includes(t)) return true;
      // also check any character of token
      return [...t].some(ch => ch && name.includes(ch));
    });
  });

  menuCards.innerHTML = "";
  list.forEach(m=>{
    const card = document.createElement("div");
    card.className = "menuCard" + (m.id===state.activeMenuId ? " active":"");
    const tag = (m.id===state.activeMenuId) ? `<div class="mTag">${state.size}</div>` : `<div class="mTag">${state.size}</div>`;
    const basePrice = toNumber(m.sizes?.[state.size]?.price,0);
    card.innerHTML = `
      ${tag}
      <div class="mName">${m.name}</div>
      <div class="mMeta">${state.size} 기본가 ${won(basePrice)}</div>
      <div class="mMeta">기본원가 ${won(toNumber(m.sizes?.[state.size]?.baseCost,0))}</div>
    `;
    card.onclick = ()=>{
      state.activeMenuId = m.id;
      ensureRadioDefaultsForMenu(m.id);
      save();
      rerender();
    };
    menuCards.appendChild(card);
  });

  if(!list.length){
    menuCards.innerHTML = `<div class="muted" style="padding:0 12px 12px">검색 결과가 없습니다.</div>`;
  }
}

function renderControls(){
  // platform options
  platformSel.innerHTML = "";
  Object.keys(cfg.platforms).forEach((k)=>{
    const opt = document.createElement("option");
    opt.value = k;
    opt.textContent = cfg.platforms[k].name;
    platformSel.appendChild(opt);
  });
  if(!cfg.platforms[state.platformKey]) state.platformKey = Object.keys(cfg.platforms)[0] || "BAEMIN_DELIVERY";
  platformSel.value = state.platformKey;

  // size seg
  sizeSeg.innerHTML = "";
  SizeKeys.forEach((s)=>{
    const b = document.createElement("button");
    b.className = "segBtn" + (state.size===s ? " active":"");
    b.textContent = s;
    b.onclick = ()=>{
      state.size=s;
      ensureRadioDefaultsForMenu(state.activeMenuId);
      save();
      rerender();
    };
    sizeSeg.appendChild(b);
  });

  // coupon 0~10000 step 1000
  couponSel.innerHTML = "";
  for(let v=0; v<=10000; v+=1000){
    const opt = document.createElement("option");
    opt.value = String(v);
    opt.textContent = v===0 ? "쿠폰 없음" : `쿠폰 ${v.toLocaleString()}원`;
    couponSel.appendChild(opt);
  }
  couponSel.value = String(state.coupon);

  // extra delivery 0~5000 step 500
  extraDeliverySel.innerHTML = "";
  for(let v=0; v<=5000; v+=500){
    const opt = document.createElement("option");
    opt.value = String(v);
    opt.textContent = v===0 ? "추가 배달비 없음" : `추가 배달비 ${v.toLocaleString()}원`;
    extraDeliverySel.appendChild(opt);
  }
  extraDeliverySel.value = String(state.storeDeliveryExtra);
}

platformSel.addEventListener("change",(e)=>{ state.platformKey=e.target.value; save(); rerender(); });
couponSel.addEventListener("change",(e)=>{ state.coupon=toNumber(e.target.value,0); save(); rerender(); });
extraDeliverySel.addEventListener("change",(e)=>{ state.storeDeliveryExtra=toNumber(e.target.value,0); save(); rerender(); });

menuSearch.addEventListener("input",()=>renderMenuCards());

menuResetBtn.addEventListener("click",()=>{
  // reset per-menu selections for current menu only
  const ms = ensureMenuState(state.activeMenuId);
  ms.checked = {};
  ms.qty = {};
  ms.radio = {};
  ensureRadioDefaultsForMenu(state.activeMenuId);
  save(); rerender();
});

resetBtn.addEventListener("click",()=>{
  // full reset (keep cfg)
  state.coupon=0;
  state.storeDeliveryExtra=0;
  Object.keys(state.menuState).forEach(mid=>{
    state.menuState[mid].checked = {};
    state.menuState[mid].qty = {};
    state.menuState[mid].radio = {};
    ensureRadioDefaultsForMenu(mid);
  });
  save(); rerender();
});

/** =========================
 *  Render: option sections
 *  ========================= */
function renderSections(){
  sections.innerHTML = "";
  const ms = currentSel();

  cfg.optionGroups.forEach(group=>{
    const list = getOptionsByGroup(group.id);
    if(!list.length) return;

    const sec = document.createElement("div");
    sec.className = "card section";

    const head = document.createElement("div");
    head.className = "secHead";
    head.innerHTML = `
      <div>
        <div class="secTitle">${group.title}</div>
        <div class="secSub">${group.subtitle || ""}</div>
      </div>
      <div class="muted">${group.kind==="check_limit" ? ("최대 "+(group.maxSelect||1)+"개") : (group.kind==="check_qty" ? "수량형" : "1개 선택")}</div>
    `;
    sec.appendChild(head);

    const body = document.createElement("div");
    body.className = "optList";

    list.forEach(opt=>{
      const row = document.createElement("div");
      row.className = "optRow";

      const left = document.createElement("div");
      left.style.display="flex";
      left.style.justifyContent="center";

      const mid = document.createElement("div");
      const right = document.createElement("div");
      right.className="rightMini";

      if(opt.type==="radio"){
        const r = document.createElement("input");
        r.type="radio";
        r.name = "rg_"+opt.groupId+"_"+state.activeMenuId;
        r.checked = ms.radio[opt.groupId]===opt.id;
        r.addEventListener("change",()=>{
          ms.radio[opt.groupId]=opt.id;
          save(); rerender();
        });
        left.appendChild(r);
      }else if(opt.type==="check"){
        const c = document.createElement("input");
        c.type="checkbox";
        c.checked = !!ms.checked[opt.id];
        c.addEventListener("change",()=>{
          // enforce maxSelect in group
          const g = getGroupMeta(opt.groupId);
          if(g && g.kind==="check_limit" && c.checked){
            const max = g.maxSelect || 1;
            const checkedInGroup = getOptionsByGroup(opt.groupId)
              .filter(o=>o.type==="check" && ms.checked[o.id])
              .map(o=>o.id);
            if(checkedInGroup.length >= max){
              ms.checked[checkedInGroup[0]] = false;
            }
          }
          ms.checked[opt.id] = !ms.checked[opt.id];
          save(); rerender();
        });
        left.appendChild(c);
      }else if(opt.type==="check_qty"){
        const c = document.createElement("input");
        c.type="checkbox";
        const q = clamp(toNumber(ms.qty[opt.id],0),0,opt.maxQty||99);
        c.checked = q>0;
        c.addEventListener("change",()=>{
          ms.qty[opt.id] = (q>0 ? 0 : 1);
          save(); rerender();
        });
        left.appendChild(c);

        const step = document.createElement("div");
        step.className="qty";
        const minus = document.createElement("button");
        minus.textContent="-";
        minus.onclick=()=>{
          ms.qty[opt.id] = clamp(toNumber(ms.qty[opt.id],0)-1,0,opt.maxQty||99);
          save(); rerender();
        };
        const num = document.createElement("div");
        num.className="n";
        num.textContent=String(q);
        const plus = document.createElement("button");
        plus.textContent="+";
        plus.onclick=()=>{
          ms.qty[opt.id] = clamp(toNumber(ms.qty[opt.id],0)+1,0,opt.maxQty||99);
          save(); rerender();
        };
        step.append(minus,num,plus);
        right.appendChild(step);
      }

      mid.innerHTML = `
        <div class="optName">${opt.name}</div>
        <div class="optMeta">+${won(opt.priceDelta)} · 원가 +${won(opt.costDelta)}</div>
      `;

      row.append(left, mid, right);
      body.appendChild(row);
    });

    sec.appendChild(body);
    sections.appendChild(sec);
  });
}

/** =========================
 *  Calculation
 *  ========================= */
function getSelectedLines(){
  const ms = currentSel();
  const lines = [];

  // radios
  Object.keys(ms.radio).forEach(gid=>{
    const id = ms.radio[gid];
    const opt = cfg.options.find(o=>o.id===id && o.enabled!==false);
    if(opt) lines.push({opt, qty:1});
  });

  // checks
  Object.keys(ms.checked).forEach(id=>{
    if(ms.checked[id]){
      const opt = cfg.options.find(o=>o.id===id && o.enabled!==false);
      if(opt) lines.push({opt, qty:1});
    }
  });

  // qty
  Object.keys(ms.qty).forEach(id=>{
    const opt = cfg.options.find(o=>o.id===id && o.enabled!==false);
    if(!opt) return;
    const q = clamp(toNumber(ms.qty[id],0),0,opt.maxQty||99);
    if(q>0) lines.push({opt, qty:q});
  });

  return lines;
}

function calcAll(){
  const menu = getMenuById(state.activeMenuId);
  const base = menu?.sizes?.[state.size] || {price:0, baseCost:0};
  const basePrice = toNumber(base.price,0);
  const baseCost = toNumber(base.baseCost,0);

  const lines = getSelectedLines();

  const optPrice = lines.reduce((s,x)=>s + toNumber(x.opt.priceDelta,0)*x.qty,0);
  const optCost  = lines.reduce((s,x)=>s + toNumber(x.opt.costDelta,0)*x.qty,0);

  const gross = basePrice + optPrice;
  const net = Math.max(0, gross - toNumber(state.coupon,0));
  const totalCost = baseCost + optCost;

  const p = cfg.platforms[state.platformKey] || {platformFeeRate:0, cardFeeRate:0, deliveryFee:0};
  const platformFee = net * toNumber(p.platformFeeRate,0);
  const cardFee = net * toNumber(p.cardFeeRate,0);
  const delivery = toNumber(p.deliveryFee,0) + toNumber(state.storeDeliveryExtra,0);

  const profit = net - platformFee - cardFee - delivery - totalCost;
  const marginRate = net>0 ? (profit/net)*100 : 0;

  return {menu, basePrice, baseCost, optPrice, optCost, gross, net, totalCost, platformFee, cardFee, delivery, profit, marginRate, lines};
}

function renderSummary(){
  const r = calcAll();
  $("grossPrice").textContent = won(r.gross);
  $("netRevenue").textContent = won(r.net);
  $("totalCost").textContent = won(r.totalCost);
  $("platformFee").textContent = won(r.platformFee);
  $("cardFee").textContent = won(r.cardFee);
  $("deliveryFee").textContent = won(r.delivery);

  const pt = `실마진 (${pct(r.marginRate)})`;
  $("profitTitle").textContent = pt;

  const profitEl = $("profit");
  profitEl.textContent = won(r.profit);
  profitEl.className = "sumValue" + (r.profit<0 ? " bad":"");

  $("ctaProfit").textContent = won(r.profit);
}

function renderOptionProfit(){
  const r = calcAll();
  profitRows.innerHTML = "";

  const selected = r.lines.filter(x => x.qty>0);
  if(!selected.length){
    profitRows.innerHTML = `<div style="color:#6b7280; font-weight:900">선택된 옵션이 없습니다.</div>`;
    return;
  }

  selected.forEach(x=>{
    const p = toNumber(x.opt.priceDelta,0)*x.qty;
    const c = toNumber(x.opt.costDelta,0)*x.qty;
    const d = p - c;
    const box = document.createElement("div");
    box.className="rowBox";
    box.innerHTML = `
      <div>
        <div style="font-weight:1000">${x.opt.name}${x.qty>1 ? " ×"+x.qty : ""}</div>
        <div style="font-size:12px; color:#6b7280; font-weight:900">${getGroupMeta(x.opt.groupId)?.title || x.opt.groupId}</div>
      </div>
      <div style="text-align:right; font-size:12px; color:#6b7280; font-weight:900">
        +${won(p)}
        <div style="margin-top:4px">원가 +${won(c)}</div>
      </div>
      <div class="divider"></div>
      <div class="profit ${d<0 ? "neg":"pos"}" style="text-align:right">${d<0 ? "" : "+"}${won(d)}</div>
    `;
    profitRows.appendChild(box);
  });
}

/** =========================
 *  Admin UI
 *  ========================= */
const tabMenus = $("tabMenus");
const tabPlatform = $("tabPlatform");
const tabOptions = $("tabOptions");
const paneMenus = $("paneMenus");
const panePlatform = $("panePlatform");
const paneOptions = $("paneOptions");

function setAdminTab(which){
  tabMenus.classList.toggle("active", which==="menus");
  tabPlatform.classList.toggle("active", which==="platform");
  tabOptions.classList.toggle("active", which==="options");
  paneMenus.style.display = (which==="menus") ? "block" : "none";
  panePlatform.style.display = (which==="platform") ? "block" : "none";
  paneOptions.style.display = (which==="options") ? "block" : "none";
  renderAdmin();
}
tabMenus.addEventListener("click",()=>setAdminTab("menus"));
tabPlatform.addEventListener("click",()=>setAdminTab("platform"));
tabOptions.addEventListener("click",()=>setAdminTab("options"));

/** Admin: Menus */
const adminMenuSel = $("adminMenuSel");
const adminMenuName = $("adminMenuName");
const mPriceS = $("mPriceS"), mPriceM = $("mPriceM"), mPriceL = $("mPriceL");
const mCostS  = $("mCostS"),  mCostM  = $("mCostM"),  mCostL  = $("mCostL");
const saveMenuBtn = $("saveMenuBtn");
const addMenuBtn = $("addMenuBtn");
const deleteMenuBtn = $("deleteMenuBtn");

function renderAdminMenuSelect(){
  adminMenuSel.innerHTML = "";
  cfg.menus.forEach(m=>{
    const opt = document.createElement("option");
    opt.value = m.id;
    opt.textContent = m.name;
    adminMenuSel.appendChild(opt);
  });
  if(!cfg.menus.some(m=>m.id===state.activeMenuId)){
    state.activeMenuId = cfg.menus[0]?.id || "";
  }
  adminMenuSel.value = state.activeMenuId;
}
function fillAdminMenuFields(){
  const m = getMenuById(adminMenuSel.value);
  adminMenuName.value = m?.name || "";
  mPriceS.value = toNumber(m?.sizes?.S?.price,0);
  mPriceM.value = toNumber(m?.sizes?.M?.price,0);
  mPriceL.value = toNumber(m?.sizes?.L?.price,0);
  mCostS.value  = toNumber(m?.sizes?.S?.baseCost,0);
  mCostM.value  = toNumber(m?.sizes?.M?.baseCost,0);
  mCostL.value  = toNumber(m?.sizes?.L?.baseCost,0);
}
adminMenuSel.addEventListener("change",()=>{
  state.activeMenuId = adminMenuSel.value;
  ensureRadioDefaultsForMenu(state.activeMenuId);
  save();
  fillAdminMenuFields();
  renderMenuCards();
  rerender();
});

saveMenuBtn.addEventListener("click",()=>{
  const m = getMenuById(adminMenuSel.value);
  if(!m) return;

  m.name = (adminMenuName.value || "").trim() || "메뉴";
  m.sizes.S.price = toNumber(mPriceS.value,0);
  m.sizes.M.price = toNumber(mPriceM.value,0);
  m.sizes.L.price = toNumber(mPriceL.value,0);
  m.sizes.S.baseCost = toNumber(mCostS.value,0);
  m.sizes.M.baseCost = toNumber(mCostM.value,0);
  m.sizes.L.baseCost = toNumber(mCostL.value,0);

  save();
  alert("저장 완료");
  renderMenuCards();
  rerender();
});

addMenuBtn.addEventListener("click",()=>{
  const name = prompt("새 메뉴명");
  if(!name) return;
  const id = uid("m");
  cfg.menus.push({
    id,
    name: name.trim(),
    sizes:{ S:{price:0, baseCost:0}, M:{price:0, baseCost:0}, L:{price:0, baseCost:0} }
  });
  state.activeMenuId = id;
  ensureMenuState(id);
  ensureRadioDefaultsForMenu(id);
  save();
  renderAdmin();
  renderMenuCards();
  rerender();
});

deleteMenuBtn.addEventListener("click",()=>{
  const m = getMenuById(adminMenuSel.value);
  if(!m) return;
  if(!confirm(`메뉴 삭제: ${m.name} (복구 불가)`)) return;
  cfg.menus = cfg.menus.filter(x=>x.id!==m.id);
  delete state.menuState[m.id];
  state.activeMenuId = cfg.menus[0]?.id || "";
  ensureRadioDefaultsForMenu(state.activeMenuId);
  save();
  renderAdmin();
  renderMenuCards();
  rerender();
});

/** Admin: Platform */
const adminPlatformSel = $("adminPlatformSel");
const pName = $("pName");
const pFeeRate = $("pFeeRate");
const pCardRate = $("pCardRate");
const pDelivery = $("pDelivery");
const savePlatformBtn = $("savePlatformBtn");
const addPlatformBtn = $("addPlatformBtn");
const deletePlatformBtn = $("deletePlatformBtn");

function renderAdminPlatforms(){
  adminPlatformSel.innerHTML = "";
  Object.keys(cfg.platforms).forEach(k=>{
    const opt = document.createElement("option");
    opt.value = k;
    opt.textContent = cfg.platforms[k].name;
    adminPlatformSel.appendChild(opt);
  });
  adminPlatformSel.value = state.platformKey;
  fillAdminPlatformFields();
}
function fillAdminPlatformFields(){
  const p = cfg.platforms[adminPlatformSel.value];
  if(!p) return;
  pName.value = p.name || "";
  pFeeRate.value = toNumber(p.platformFeeRate,0);
  pCardRate.value = toNumber(p.cardFeeRate,0);
  pDelivery.value = toNumber(p.deliveryFee,0);
}
adminPlatformSel.addEventListener("change",()=>{
  state.platformKey = adminPlatformSel.value;
  save();
  fillAdminPlatformFields();
  rerender();
});

savePlatformBtn.addEventListener("click",()=>{
  const k = adminPlatformSel.value;
  const p = cfg.platforms[k];
  if(!p) return;
  p.name = (pName.value || "").trim() || p.name;
  p.platformFeeRate = toNumber(pFeeRate.value,0);
  p.cardFeeRate = toNumber(pCardRate.value,0);
  p.deliveryFee = toNumber(pDelivery.value,0);
  save();
  alert("저장 완료");
  rerender(true);
});

addPlatformBtn.addEventListener("click",()=>{
  const key = prompt("플랫폼 Key (영문/숫자/언더스코어) 예: NEW_PLATFORM");
  if(!key) return;
  if(cfg.platforms[key]){ alert("이미 존재합니다."); return; }
  const name = prompt("플랫폼 표시명") || key;
  cfg.platforms[key] = { name, platformFeeRate:0, cardFeeRate:0.03, deliveryFee:0 };
  state.platformKey = key;
  save();
  renderAdmin();
  rerender(true);
});

deletePlatformBtn.addEventListener("click",()=>{
  const k = adminPlatformSel.value;
  if(!cfg.platforms[k]) return;
  if(!confirm(`플랫폼 삭제: ${cfg.platforms[k].name} (복구 불가)`)) return;
  delete cfg.platforms[k];
  state.platformKey = Object.keys(cfg.platforms)[0] || "BAEMIN_DELIVERY";
  save();
  renderAdmin();
  rerender(true);
});

/** Admin: Options (Sheet2) */
const groupList = $("groupList");
const optionList = $("optionList");
const addGroupBtn = $("addGroupBtn");
const addOptionBtn = $("addOptionBtn");

function kindToType(kind){
  if(kind==="radio") return "radio";
  if(kind==="check_qty") return "check_qty";
  return "check";
}
function renderGroupList(){
  groupList.innerHTML = "";
  cfg.optionGroups.forEach(g=>{
    const box = document.createElement("div");
    box.className = "miniCard";
    box.innerHTML = `
      <div class="row">
        <div>
          <div class="name">${g.title}</div>
          <div class="sub">ID: ${g.id} · kind: ${g.kind} · max: ${g.maxSelect||1}</div>
        </div>
        <div class="right">
          <button class="smallBtn light" data-act="edit">수정</button>
          <button class="smallBtn dangerBtn" data-act="del">삭제</button>
        </div>
      </div>
    `;
    box.querySelector('[data-act="edit"]').onclick = ()=>{
      const title = prompt("그룹명", g.title);
      if(!title) return;
      const subtitle = prompt("그룹 설명(서브)", g.subtitle || "") ?? g.subtitle;
      const kind = prompt("그룹 종류 (radio / check_limit / check_qty)", g.kind) || g.kind;
      const maxSelect = toNumber(prompt("maxSelect (radio=1, check_limit=최대 N, check_qty=최대 N)", String(g.maxSelect||1)), g.maxSelect||1);
      g.title = title.trim();
      g.subtitle = (subtitle ?? "").trim();
      g.kind = (["radio","check_limit","check_qty"].includes(kind) ? kind : g.kind);
      g.maxSelect = maxSelect || 1;

      // auto-align existing option types with group kind
      const t = kindToType(g.kind);
      cfg.options.filter(o=>o.groupId===g.id).forEach(o=>{
        o.type = t;
        if(t==="check_qty" && !o.maxQty) o.maxQty = g.maxSelect || 4;
        if(t!=="check_qty") o.maxQty = 1;
      });

      save();
      renderAdmin();
      rerender();
    };
    box.querySelector('[data-act="del"]').onclick = ()=>{
      if(!confirm(`그룹 삭제: ${g.title}\n(해당 그룹 옵션도 같이 삭제)`)) return;
      cfg.optionGroups = cfg.optionGroups.filter(x=>x.id!==g.id);
      cfg.options = cfg.options.filter(o=>o.groupId!==g.id);
      // clean per-menu selections
      Object.values(state.menuState).forEach(ms=>{
        delete ms.radio[g.id];
      });
      save();
      renderAdmin();
      rerender();
    };
    groupList.appendChild(box);
  });

  if(!cfg.optionGroups.length){
    groupList.innerHTML = `<div class="muted">그룹이 없습니다. + 그룹 추가를 눌러 생성하세요.</div>`;
  }
}

function renderOptionList(){
  optionList.innerHTML = "";
  cfg.options.forEach(o=>{
    const g = getGroupMeta(o.groupId);
    const box = document.createElement("div");
    box.className = "miniCard";
    box.innerHTML = `
      <div class="row">
        <div>
          <div class="name">${o.name}</div>
          <div class="sub">그룹: ${g?.title || o.groupId} · type: ${o.type} · 판매가 +${won(o.priceDelta)} · 원가 +${won(o.costDelta)} · ${o.enabled===false ? "OFF" : "ON"}</div>
        </div>
        <div class="right">
          <button class="smallBtn light" data-act="edit">수정</button>
          <button class="smallBtn light" data-act="toggle">${o.enabled===false ? "ON" : "OFF"}</button>
          <button class="smallBtn dangerBtn" data-act="del">삭제</button>
        </div>
      </div>
    `;
    box.querySelector('[data-act="edit"]').onclick = ()=>{
      const name = prompt("옵션명", o.name);
      if(!name) return;

      const groupId = prompt("그룹ID (현재: "+o.groupId+")\n가능: "+cfg.optionGroups.map(x=>x.id).join(", "), o.groupId) || o.groupId;
      if(!cfg.optionGroups.some(x=>x.id===groupId)){
        alert("그룹ID가 없습니다. 먼저 그룹을 만드세요.");
        return;
      }
      const price = toNumber(prompt("옵션 판매가(추가금)", String(o.priceDelta)), o.priceDelta);
      const cost = toNumber(prompt("옵션 원가(추가원가)", String(o.costDelta)), o.costDelta);

      let maxQty = o.maxQty || 1;
      const g2 = getGroupMeta(groupId);
      const t = kindToType(g2?.kind || "radio");
      if(t==="check_qty"){
        maxQty = toNumber(prompt("최대 수량(maxQty)", String(o.maxQty || (g2?.maxSelect||4))), o.maxQty || (g2?.maxSelect||4));
      }else{
        maxQty = 1;
      }

      o.name = name.trim();
      o.groupId = groupId;
      o.type = t;
      o.priceDelta = price;
      o.costDelta = cost;
      o.maxQty = maxQty;

      save();
      renderAdmin();
      rerender();
    };
    box.querySelector('[data-act="toggle"]').onclick = ()=>{
      o.enabled = (o.enabled===false) ? true : false;
      save();
      renderAdmin();
      rerender();
    };
    box.querySelector('[data-act="del"]').onclick = ()=>{
      if(!confirm(`옵션 삭제: ${o.name} (복구 불가)`)) return;
      // clean selections
      Object.values(state.menuState).forEach(ms=>{
        if(ms.checked) delete ms.checked[o.id];
        if(ms.qty) delete ms.qty[o.id];
        Object.keys(ms.radio||{}).forEach(gid=>{
          if(ms.radio[gid]===o.id) delete ms.radio[gid];
        });
      });
      cfg.options = cfg.options.filter(x=>x.id!==o.id);
      save();
      renderAdmin();
      rerender();
    };
    optionList.appendChild(box);
  });

  if(!cfg.options.length){
    optionList.innerHTML = `<div class="muted">옵션이 없습니다. + 옵션 추가를 눌러 생성하세요.</div>`;
  }
}

addGroupBtn.addEventListener("click",()=>{
  const id = prompt("그룹 ID (영문 대문자 추천) 예: EDGE, TOPPING") || "";
  if(!id.trim()) return;
  if(cfg.optionGroups.some(g=>g.id===id.trim())){ alert("이미 존재합니다."); return; }
  const title = prompt("그룹명") || id.trim();
  const subtitle = prompt("서브텍스트(예: 필수 / 최대 2개)") || "";
  const kind = prompt("그룹 종류 (radio / check_limit / check_qty)", "radio") || "radio";
  const maxSelect = toNumber(prompt("maxSelect (radio=1, check_limit=최대 N, check_qty=최대 N)", kind==="radio" ? "1" : "2"), kind==="radio" ? 1 : 2);

  cfg.optionGroups.push({
    id: id.trim(),
    title: title.trim(),
    subtitle: subtitle.trim(),
    kind: (["radio","check_limit","check_qty"].includes(kind) ? kind : "radio"),
    maxSelect: maxSelect || 1
  });
  save();
  renderAdmin();
  rerender();
});

addOptionBtn.addEventListener("click",()=>{
  if(!cfg.optionGroups.length){
    alert("먼저 옵션 그룹을 추가하세요.");
    return;
  }
  const name = prompt("옵션명") || "";
  if(!name.trim()) return;

  const groupId = prompt("그룹ID 선택\n가능: "+cfg.optionGroups.map(x=>x.id).join(", "), cfg.optionGroups[0].id) || cfg.optionGroups[0].id;
  const g = getGroupMeta(groupId);
  if(!g){ alert("그룹ID가 없습니다."); return; }

  const type = kindToType(g.kind);
  const priceDelta = toNumber(prompt("옵션 판매가(추가금)", "0"), 0);
  const costDelta = toNumber(prompt("옵션 원가(추가원가)", "0"), 0);
  const maxQty = (type==="check_qty") ? toNumber(prompt("최대 수량(maxQty)", String(g.maxSelect||4)), g.maxSelect||4) : 1;

  cfg.options.push({
    id: uid("opt"),
    groupId,
    type,
    name: name.trim(),
    priceDelta,
    costDelta,
    maxQty,
    enabled: true
  });

  save();
  renderAdmin();
  rerender();
});

function renderAdmin(){
  // keep header blocks
  renderAppTitle();

  // menus
  renderAdminMenuSelect();
  fillAdminMenuFields();

  // platforms
  renderAdminPlatforms();

  // options
  renderGroupList();
  renderOptionList();
}

/** =========================
 *  Main rerender
 *  ========================= */
function rerender(full=true){
  // page toggle
  const isMenu = state.page==="menu";
  menuHeaderBlock.classList.toggle("on", isMenu);
  menuHeaderBlock.classList.toggle("page", true);
  adminHeaderBlock.classList.toggle("on", !isMenu);
  adminHeaderBlock.classList.toggle("page", true);

  pageMenu.classList.toggle("on", isMenu);
  pageMenu.classList.toggle("page", true);
  pageAdmin.classList.toggle("on", !isMenu);
  pageAdmin.classList.toggle("page", true);

  goMenuBtn.classList.toggle("on", isMenu);
  goAdminBtn.classList.toggle("on", !isMenu);

  renderAppTitle();

  if(isMenu){
    ensureRadioDefaultsForMenu(state.activeMenuId);
    if(full){
      renderControls();
      renderMenuCards();
    }else{
      // still update menu meta prices on cards
      renderMenuCards();
    }
    renderSections();
    renderSummary();
    renderOptionProfit();
  }else{
    renderAdmin();
  }
}

/** =========================
 *  Boot
 *  ========================= */
(function boot(){
  if(!cfg.menus?.length){
    cfg.menus = DEFAULT.menus;
  }
  if(!cfg.platforms || !Object.keys(cfg.platforms).length){
    cfg.platforms = DEFAULT.platforms;
  }
  if(!cfg.optionGroups?.length){
    cfg.optionGroups = DEFAULT.optionGroups;
  }
  if(!cfg.options?.length){
    cfg.options = DEFAULT.options;
  }

  if(!state.activeMenuId || !cfg.menus.some(m=>m.id===state.activeMenuId)){
    state.activeMenuId = cfg.menus[0].id;
  }
  ensureRadioDefaultsForMenu(state.activeMenuId);

  // default admin tab = menus
  setAdminTab("menus");

  save();
  rerender(true);
})();
</script>
</body>
</html>
